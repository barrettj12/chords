<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Song - Jordy's Chordies</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header class="header">
    <div class="header-content">
      <a href="/c/artists" class="logo">
        üéµ Jordy's Chordies
      </a>
      <div class="search-container">
        <input type="text" class="search-box" placeholder="Search artists or songs..." id="search-box">
        <div class="search-suggestions" id="search-suggestions"></div>
      </div>
    </div>
  </header>

  <main class="main-content">
    <div class="song-header">
      <h1 class="song-title" id="song-title">Loading...</h1>
      <div class="song-artist" id="song-artist">Loading...</div>
      
      <div class="song-controls">
        <a href="#" class="btn btn-secondary" id="back-btn">‚Üê Back to Artist</a>
        
        <div class="transpose-controls">
          <button class="transpose-btn" id="transpose-down">‚àí</button>
          <div class="current-key" id="current-key">Original Key</div>
          <button class="transpose-btn" id="transpose-up">+</button>
        </div>
      </div>
    </div>

    <div class="chord-sheet">
      <pre class="chord-content" id="chord-content">Loading chords...</pre>
    </div>

    <div class="loading" id="loading">Loading song...</div>
    <div class="error" id="error" style="display: none;"></div>
  </main>

  <footer class="footer">
    <div class="footer-content">
      <p>&copy; 2025 Jordy's Chordies. All rights reserved.</p>
      <p>
        <a href="https://github.com/barrettj12/chords" target="_blank">
          View on GitHub
        </a>
      </p>
    </div>
  </footer>

  <script type="module">
    // Import transposing library
		import { transpose } from "https://barrettj12.github.io/chord-transposer/js/Main.js";

    // Song data
    let songData = {};
    let originalChords = '';
    let currentTransposition = 0;
    
    // DOM elements
    const searchBox = document.getElementById('search-box');
    const searchSuggestions = document.getElementById('search-suggestions');
    const songTitle = document.getElementById('song-title');
    const songArtist = document.getElementById('song-artist');
    const backBtn = document.getElementById('back-btn');
    const transposeDown = document.getElementById('transpose-down');
    const transposeUp = document.getElementById('transpose-up');
    const currentKey = document.getElementById('current-key');
    // TODO add reset button
    const chordContent = document.getElementById('chord-content');
    const loading = document.getElementById('loading');
    const error = document.getElementById('error');

    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
      // Check for cookie and restore previous transpose
			currentTransposition = document.cookie.split("; ").
				find((row) => row.startsWith("{{.ID}}="))?.split("=")[1] || 0;

      const urlParams = new URLSearchParams(window.location.search);
      const id = urlParams.get('id');
      
      if (id) {
        loadSongChords(id);
      } else {
        showError('Artist or song not specified');
        loading.style.display = 'none';
      }
      
      setupSearch();
      setupTransposeControls();
    });

    // Load song chords from API (placeholder function)
    async function loadSongChords(id) {
      try {
        const chordsResp = await fetch(`/api/v0/chords?id=${encodeURIComponent(id)}`);
        originalChords = await chordsResp.text();
        updateChordDisplay();
        
        const dataResp = await fetch(`/api/v0/songs?id=${encodeURIComponent(id)}`);
        const songData = await dataResp.json();
        updateSongInfo(songData[0]);
        loading.style.display = 'none';
      } catch (err) {
        console.log(err)
        showError('Failed to load song chords. Please try again.');
        loading.style.display = 'none';
      }
    }

    // Update song information
    function updateSongInfo(songData) {
      songTitle.textContent = songData.name;
      songArtist.textContent = `by ${songData.artist}`;
      document.title = `${songData.name} - ${songData.artist} - Jordy's Chordies`;
      
      // Update back button
      backBtn.href = `/c/songs?artist=${encodeURIComponent(songData.artist)}`;
      
      updateKeyDisplay();
    }

    // Update key display
    function updateKeyDisplay() {
      currentKey.textContent = currentTransposition
    }

    // Update chord display
    function updateChordDisplay() {
      chordContent.textContent = transpose(originalChords, currentTransposition);
			document.cookie = "{{.ID}}="+currentTransposition;
    }

    // Setup transpose controls
    function setupTransposeControls() {
      transposeDown.addEventListener('click', tuneDown);
      transposeUp.addEventListener('click', tuneUp);
    }

    function resetTranspose() {
      currentTransposition = 0;
      updateChordDisplay();
      updateKeyDisplay()
    }

    function tuneUp() {
      currentTransposition++;
      updateChordDisplay();
      updateKeyDisplay()
    }

    function tuneDown() {
      currentTransposition--;
      updateChordDisplay();
      updateKeyDisplay()
    }

    // Setup search functionality
    function setupSearch() {
      let searchTimeout;
      
      searchBox.addEventListener('input', function(e) {
        clearTimeout(searchTimeout);
        const query = e.target.value.trim();
        
        if (query.length === 0) {
          hideSuggestions();
          return;
        }
        
        searchTimeout = setTimeout(() => {
          if (query.length >= 2) {
            showSuggestions(query);
          }
        }, 150);
      });
      
      searchBox.addEventListener('focus', function() {
        if (searchBox.value.trim().length >= 2) {
          showSuggestions(searchBox.value.trim());
        }
      });
      
      document.addEventListener('click', function(e) {
        if (!searchBox.contains(e.target) && !searchSuggestions.contains(e.target)) {
          hideSuggestions();
        }
      });
    }

    // Show search suggestions (placeholder)
    function showSuggestions(query) {
      // This would normally search through all artists/songs
      // For now, just hide suggestions since we don't have the full data
      hideSuggestions();
    }

    // Hide search suggestions
    function hideSuggestions() {
      searchSuggestions.classList.remove('show');
    }

    // Show error message
    function showError(message) {
      error.textContent = message;
      error.style.display = 'block';
    }
  </script>
</body>
</html>